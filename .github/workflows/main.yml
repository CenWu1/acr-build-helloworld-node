on: [push]
name: Linux_Container_Workflow

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
        # checkout the repo
        - name: 'Checkout GitHub Action'
          uses: actions/checkout@main

        - name: 'Login via Azure CLI'
          uses: azure/login@v1
          with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}
            environment: AzureChinaCloud
            
        - name: 'Debug Azure Context'
          run: |
            set -e
            echo "== Cloud =="
            az cloud show
            echo "== Subscriptions visible to this SP =="
            az account list --all -o table
            echo "== Current account =="
            az account show
            echo "== SP object (by clientId) =="

        - name: 'Build and push image'
          uses: azure/docker-login@v1
          with:
            login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
            username: ${{ secrets.REGISTRY_USERNAME }}
            password: ${{ secrets.REGISTRY_PASSWORD }}
        - run: |
            docker build . -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/sampleapp:${{ github.sha }}
            docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/sampleapp:${{ github.sha }}

        - name: 'Deploy to Azure Container Instances'
          uses: 'azure/aci-deploy@v1'
          with:
            resource-group: ${{ secrets.RESOURCE_GROUP }}
            dns-name-label: ${{ secrets.RESOURCE_GROUP }}${{ github.run_number }}
            image: ${{ secrets.REGISTRY_LOGIN_SERVER }}/sampleapp:${{ github.sha }}
            registry-login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
            registry-username: ${{ secrets.REGISTRY_USERNAME }}
            registry-password: ${{ secrets.REGISTRY_PASSWORD }}
            name: aci-sampleapp
            location: 'chinaeast2'
            
        - name: Deploy via Azure CLI (bypass aci-deploy)
          if: ${{ failure() }} # 仅在上一步失败时执行
          run: |
            set -e
            az account set --subscription 07d1a987-0258-4086-800b-550fdd074fcd
            az container create \
              --resource-group ${{ secrets.RESOURCE_GROUP }} \
              --name aci-sampleapp-cli \
              --image ${{ secrets.REGISTRY_LOGIN_SERVER }}/sampleapp:${{ github.sha }} \
              --os-type Linux \
              --location chinaeast2 \
              --dns-name-label ${{ secrets.RESOURCE_GROUP }}${{ github.run_number }}cli \
              --registry-login-server ${{ secrets.REGISTRY_LOGIN_SERVER }} \
              --registry-username ${{ secrets.REGISTRY_USERNAME }} \
              --registry-password ${{ secrets.REGISTRY_PASSWORD }} \
              --ports 80
            az container show -g ${{ secrets.RESOURCE_GROUP }} -n aci-sampleapp-cli -o 

